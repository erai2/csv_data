<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>suri QnA AI</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 300px 1fr;
            grid-gap: 20px;
            min-height: 100vh;
        }

        /* 헤더 */
        .header {
            grid-column: 1 / -1;
            text-align: center;
            padding: 2rem 0;
            color: white;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* 사이드바 */
        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            height: fit-content;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .sidebar h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        /* 파일 업로드 */
        .upload-area {
            border: 2px dashed #007acc;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background-color: #f8f9fa;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background-color: #e9ecef;
            border-color: #0056b3;
        }

        .upload-area.dragover {
            background-color: #cfe2ff;
            border-color: #0d6efd;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }

        /* 메트릭 카드 */
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #4CAF50;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        /* 메인 콘텐츠 */
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* 탭 네비게이션 */
        .tab-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-button:hover {
            background: #e9ecef;
            color: #212529;
        }

        .tab-button.active {
            background: white;
            color: #007acc;
            border-bottom: 3px solid #007acc;
        }

        .tab-content {
            padding: 30px;
            min-height: 600px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* 채팅 인터페이스 */
        .chat-container {
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #fafafa;
        }

        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 15px;
            max-width: 80%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .message.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            margin-right: 0;
        }

        .message.assistant {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            margin-left: 0;
            margin-right: auto;
        }

        .message-meta {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 10px;
        }

        .feedback-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .feedback-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 5px 10px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .feedback-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .chat-input-area {
            padding: 20px;
            border-top: 1px solid #ddd;
            background: white;
        }

        .chat-input {
            width: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            border-color: #007acc;
            box-shadow: 0 0 10px rgba(0,122,204,0.3);
        }

        /* 차트 컨테이너 */
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* 설정 폼 */
        .settings-form {
            display: grid;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 500;
            color: #333;
        }

        .form-control {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #007acc;
            box-shadow: 0 0 5px rgba(0,122,204,0.3);
        }

        /* 진행 바 */
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        /* 로딩 스피너 */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007acc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 알림 메시지 */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border-color: #28a745;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border-color: #ffc107;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 10px;
            }

            .sidebar {
                order: 2;
            }

            .main-content {
                order: 1;
            }

            .header h1 {
                font-size: 2rem;
            }

            .message {
                max-width: 95%;
            }

            .tab-button {
                font-size: 14px;
                padding: 12px;
            }
        }

        /* 파일 목록 */
        .file-list {
            list-style: none;
            padding: 0;
        }

        .file-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-item i {
            color: #007acc;
        }

        /* 히든 인풋 */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <div class="header">
            <h1><i class="fas fa-crystal-ball"></i> 사주명리 AI 상담사</h1>
            <p>AI 기반 전문 사주명리학 상담 서비스</p>
        </div>

        <!-- 사이드바 -->
        <div class="sidebar">
            <!-- 지식 베이스 관리 -->
            <div class="sidebar-section">
                <h3><i class="fas fa-book"></i> 지식 베이스 관리</h3>
                
                <div class="metrics">
                    <div class="metric-card">
                        <div class="metric-value" id="totalDocs">0</div>
                        <div class="metric-label">지식 문서</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="totalChunks">0</div>
                        <div class="metric-label">텍스트 청크</div>
                    </div>
                </div>

                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt fa-2x" style="color: #007acc; margin-bottom: 10px;"></i>
                    <p>파일을 드래그하거나 클릭하여 업로드</p>
                    <small>TXT, MD, PDF 파일 지원 (최대 10MB)</small>
                </div>
                
                <input type="file" id="fileInput" class="hidden" multiple accept=".txt,.md,.pdf">
                
                <button class="btn" onclick="rebuildDatabase()">
                    <i class="fas fa-sync-alt"></i> 데이터베이스 재구축
                </button>

                <div id="fileList">
                    <h4 style="margin: 15px 0 10px 0;">업로드된 파일:</h4>
                    <ul class="file-list" id="uploadedFiles"></ul>
                </div>
            </div>

            <!-- 대화 관리 -->
            <div class="sidebar-section">
                <h3><i class="fas fa-comments"></i> 대화 관리</h3>
                
                <div class="metric-card">
                    <div class="metric-value" id="chatCount">0</div>
                    <div class="metric-label">현재 대화 수</div>
                </div>

                <button class="btn btn-secondary" onclick="clearChat()">
                    <i class="fas fa-trash"></i> 대화 삭제
                </button>
                
                <button class="btn btn-secondary" onclick="exportChat()">
                    <i class="fas fa-download"></i> 대화 저장
                </button>
            </div>

            <!-- 바로가기 -->
            <div class="sidebar-section">
                <h3><i class="fas fa-link"></i> 바로가기</h3>
                <button class="btn btn-secondary" onclick="switchTab('analytics')">
                    <i class="fas fa-chart-bar"></i> 분석
                </button>
                <button class="btn btn-secondary" onclick="switchTab('settings')">
                    <i class="fas fa-cog"></i> 설정
                </button>
            </div>
        </div>

        <!-- 메인 콘텐츠 -->
        <div class="main-content">
            <!-- 탭 네비게이션 -->
            <div class="tab-nav">
                <button class="tab-button active" onclick="switchTab('chat')">
                    <i class="fas fa-comments"></i> AI 상담
                </button>
                <button class="tab-button" onclick="switchTab('analytics')">
                    <i class="fas fa-chart-bar"></i> 분석 대시보드
                </button>
                <button class="tab-button" onclick="switchTab('settings')">
                    <i class="fas fa-cog"></i> 설정
                </button>
            </div>

            <!-- 채팅 탭 -->
            <div class="tab-content">
                <div class="tab-pane active" id="chatPane">
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages">
                            <div class="message assistant">
                                <div>안녕하세요! 사주명리 AI 상담사입니다. 궁금한 것이 있으시면 언제든 물어보세요.</div>
                                <div class="message-meta">
                                    <i class="fas fa-robot"></i> 2024-01-15 14:30:25
                                </div>
                            </div>
                        </div>
                        <div class="chat-input-area">
                            <input type="text" class="chat-input" id="chatInput" 
                                   placeholder="사주명리학에 대해 궁금한 것을 물어보세요..." 
                                   onkeypress="handleChatInput(event)">
                        </div>
                    </div>
                </div>

                <!-- 분석 탭 -->
                <div class="tab-pane" id="analyticsPane">
                    <h2><i class="fas fa-chart-line"></i> 사용 통계</h2>
                    
                    <div class="metrics">
                        <div class="metric-card">
                            <div class="metric-value">24</div>
                            <div class="metric-label">총 대화 수</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">18</div>
                            <div class="metric-label">긍정적 피드백</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">3</div>
                            <div class="metric-label">부정적 피드백</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">85.7%</div>
                            <div class="metric-label">만족도</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3>인기 검색어</h3>
                        <div style="padding: 20px;">
                            <div style="margin-bottom: 15px;">
                                <strong>십신</strong> - 45회 (성공률: 92%)
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 92%"></div>
                                </div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <strong>갑목 일간</strong> - 38회 (성공률: 89%)
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 89%"></div>
                                </div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <strong>대운</strong> - 32회 (성공률: 95%)
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 95%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3>시스템 성능</h3>
                        <div class="metrics">
                            <div class="metric-card">
                                <div class="metric-value">1.2s</div>
                                <div class="metric-label">평균 응답시간</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">67%</div>
                                <div class="metric-label">메모리 사용률</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">42%</div>
                                <div class="metric-label">CPU 사용률</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 설정 탭 -->
                <div class="tab-pane" id="settingsPane">
                    <h2><i class="fas fa-cog"></i> 시스템 설정</h2>
                    
                    <div class="settings-form">
                        <h3>AI 모델 설정</h3>
                        <div class="form-group">
                            <label for="modelSelect">GPT 모델:</label>
                            <select class="form-control" id="modelSelect">
                                <option value="gpt-4o-mini">GPT-4o Mini</option>
                                <option value="gpt-4o">GPT-4o</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="maxTokens">최대 토큰 수:</label>
                            <input type="number" class="form-control" id="maxTokens" value="1500" min="100" max="4000">
                        </div>

                        <div class="form-group">
                            <label for="temperature">창의성 수준 (Temperature):</label>
                            <input type="range" class="form-control" id="temperature" min="0" max="1" step="0.1" value="0.3">
                            <small>현재 값: <span id="temperatureValue">0.3</span></small>
                        </div>

                        <h3>검색 엔진 설정</h3>
                        <div class="form-group">
                            <label for="searchResults">검색 결과 수:</label>
                            <input type="number" class="form-control" id="searchResults" value="5" min="1" max="20">
                        </div>

                        <div class="form-group">
                            <label for="vectorWeight">벡터 검색 가중치:</label>
                            <input type="range" class="form-control" id="vectorWeight" min="0" max="1" step="0.1" value="0.6">
                            <small>현재 값: <span id="vectorWeightValue">0.6</span></small>
                        </div>

                        <div class="form-group">
                            <label for="keywordWeight">키워드 검색 가중치:</label>
                            <input type="range" class="form-control" id="keywordWeight" min="0" max="1" step="0.1" value="0.4">
                            <small>현재 값: <span id="keywordWeightValue">0.4</span></small>
                        </div>

                        <button class="btn" onclick="saveSettings()">
                            <i class="fas fa-save"></i> 설정 저장
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let chatHistory = [];
        let uploadedFiles = [];
        let sessionId = generateSessionId();

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            updateMetrics();
        });

        function initializeApp() {
            // 로컬 스토리지에서 데이터 로드
            loadChatHistory();
            loadUploadedFiles();
            loadSettings();
        }

        function setupEventListeners() {
            // 파일 업로드 영역 이벤트
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            
            fileInput.addEventListener('change', handleFileSelect);

            // 슬라이더 값 업데이트
            document.getElementById('temperature').addEventListener('input', function() {
                document.getElementById('temperatureValue').textContent = this.value;
            });

            document.getElementById('vectorWeight').addEventListener('input', function() {
                document.getElementById('vectorWeightValue').textContent = this.value;
                // 키워드 가중치 자동 조정
                const keywordWeight = (1 - parseFloat(this.value)).toFixed(1);
                document.getElementById('keywordWeight').value = keywordWeight;
                document.getElementById('keywordWeightValue').textContent = keywordWeight;
            });

            document.getElementById('keywordWeight').addEventListener('input', function() {
                document.getElementById('keywordWeightValue').textContent = this.value;
                // 벡터 가중치 자동 조정
                const vectorWeight = (1 - parseFloat(this.value)).toFixed(1);
                document.getElementById('vectorWeight').value = vectorWeight;
                document.getElementById('vectorWeightValue').textContent = vectorWeight;
            });
        }

        // 탭 전환
        function switchTab(tabName) {
            // 모든 탭 버튼 비활성화
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));

            // 선택된 탭 활성화
            event.target.classList.add('active');
            document.getElementById(tabName + 'Pane').classList.add('active');
        }

        // 채팅 입력 처리
        function handleChatInput(event) {
            if (event.key === 'Enter') {
                const input = event.target;
                const message = input.value.trim();
                if (message) {
                    sendMessage(message);
                    input.value = '';
                }
            }
        }

        // 메시지 전송
        function sendMessage(message) {
            const userMessage = {
                id: Date.now(),
                role: 'user',
                content: message,
                timestamp: new Date().toLocaleString()
            };

            chatHistory.push(userMessage);
            displayMessage(userMessage);

            // AI 응답 시뮬레이션
            setTimeout(() => {
                const aiResponse = generateAIResponse(message);
                const assistantMessage = {
                    id: Date.now(),
                    role: 'assistant',
                    content: aiResponse,
                    timestamp: new Date().toLocaleString(),
                    sources: generateMockSources()
                };

                chatHistory.push(assistantMessage);
                displayMessage(assistantMessage);
                saveChatHistory();
                updateMetrics();
            }, 1000);

            updateMetrics();
        }

        // 메시지 표시
        function displayMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${message.role}`;
            messageEl.innerHTML = `
                <div>${message.content}</div>
                <div class="message-meta">
                    <i class="fas fa-${message.role === 'user' ? 'user' : 'robot'}"></i>
                    ${message.timestamp}
                </div>
                ${message.role === 'assistant' ? generateFeedbackButtons(message.id) : ''}
                ${message.sources ? generateSourcesSection(message.sources) : ''}
            `;

            messagesContainer.appendChild(messageEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // 피드백 버튼 생성
        function generateFeedbackButtons(messageId) {
            return `
                <div class="feedback-buttons">
                    <button class="feedback-btn" onclick="handleFeedback(${messageId}, 'positive')" title="도움이 되었어요">
                        👍
                    </button>
                    <button class="feedback-btn" onclick="handleFeedback(${messageId}, 'negative')" title="도움이 되지 않았어요">
                        👎
                    </button>
                    <button class="feedback-btn" onclick="regenerateResponse(${messageId})" title="답변 재생성">
                        🔄
                    </button>
                </div>
            `;
        }

        // 소스 섹션 생성
        function generateSourcesSection(sources) {
            return `
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
                    <details>
                        <summary style="cursor: pointer;">📚 참고 자료 (${sources.length}개)</summary>
                        <div style="margin-top: 10px;">
                            ${sources.map((source, i) => `
                                <div style="margin-bottom: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                    <strong>출처 ${i+1}: ${source.filename}</strong><br>
                                    <div style="margin-top: 5px; font-size: 0.9em;">${source.content}</div>
                                </div>
                            `).join('')}
                        </div>
                    </details>
                </div>
            `;
        }

        // AI 응답 생성 (시뮬레이션)
        function generateAIResponse(userMessage) {
            const responses = [
                "사주명리학에서 십신(十神)은 일간을 중심으로 다른 천간과의 관계를 나타내는 중요한 개념입니다. 비견, 겁재, 식신, 상관, 편재, 정재, 편관, 정관, 편인, 정인으로 구성되어 있습니다.",
                "갑목 일간은 양의 기운을 가진 목 오행으로, 봄에 태어난 경우 성장하는 나무의 성격을 나타냅니다. 적극적이고 진취적인 성향을 보이는 것이 특징입니다.",
                "대운은 10년마다 바뀌는 운세의 흐름을 의미합니다. 월주의 간지를 기준으로 계산하며, 인생의 큰 변화와 흐름을 예측하는 데 사용됩니다.",
                "천간과 지지의 조합은 사주 해석에서 매우 중요한 요소입니다. 각각의 조합이 가지는 의미와 상호작용을 통해 개인의 성격과 운세를 파악할 수 있습니다."
            ];
            
            const randomIndex = Math.floor(Math.random() * responses.length);
            return responses[randomIndex];
        }

        // 모의 소스 생성
        function generateMockSources() {
            return [
                {
                    filename: "사주명리학_기초이론.txt",
                    content: "십신은 일간을 중심으로 한 관계 분석의 핵심 도구입니다..."
                },
                {
                    filename: "천간지지_해석법.md", 
                    content: "천간과 지지의 조합을 통해 개인의 성향을 파악할 수 있습니다..."
                }
            ];
        }

        // 피드백 처리
        function handleFeedback(messageId, feedbackType) {
            showAlert(`피드백을 주셔서 감사합니다! ${feedbackType === 'positive' ? '👍' : '👎'}`, 'success');
            
            // 피드백 저장 (로컬 스토리지)
            const feedback = {
                messageId: messageId,
                type: feedbackType,
                timestamp: new Date().toISOString()
            };
            
            const existingFeedback = JSON.parse(localStorage.getItem('feedbackHistory') || '[]');
            existingFeedback.push(feedback);
            localStorage.setItem('feedbackHistory', JSON.stringify(existingFeedback));
        }

        // 답변 재생성
        function regenerateResponse(messageId) {
            showAlert('새로운 답변을 생성하는 중...', 'warning');
            
            setTimeout(() => {
                // 기존 메시지 찾기
                const messageIndex = chatHistory.findIndex(msg => msg.id === messageId);
                if (messageIndex > 0) {
                    const userMessage = chatHistory[messageIndex - 1].content;
                    const newResponse = generateAIResponse(userMessage);
                    
                    // 메시지 업데이트
                    chatHistory[messageIndex].content = newResponse;
                    chatHistory[messageIndex].timestamp = new Date().toLocaleString();
                    
                    // 화면 다시 렌더링
                    refreshChatDisplay();
                    showAlert('새로운 답변이 생성되었습니다!', 'success');
                }
            }, 1000);
        }

        // 채팅 화면 새로고침
        function refreshChatDisplay() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            chatHistory.forEach(message => {
                displayMessage(message);
            });
        }

        // 파일 업로드 관련 함수들
        function handleDragOver(e) {
            e.preventDefault();
            e.target.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.target.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.target.classList.remove('dragover');
            const files = e.dataTransfer.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (validateFile(file)) {
                    uploadFile(file);
                }
            });
        }

        function validateFile(file) {
            const allowedTypes = ['.txt', '.md', '.pdf'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            const maxSize = 10 * 1024 * 1024; // 10MB

            if (!allowedTypes.includes(fileExtension)) {
                showAlert(`지원하지 않는 파일 형식입니다: ${file.name}`, 'error');
                return false;
            }

            if (file.size > maxSize) {
                showAlert(`파일 크기가 10MB를 초과합니다: ${file.name}`, 'error');
                return false;
            }

            return true;
        }

        function uploadFile(file) {
            const fileInfo = {
                name: file.name,
                size: file.size,
                type: file.type,
                uploadTime: new Date().toISOString()
            };

            uploadedFiles.push(fileInfo);
            updateFileList();
            saveUploadedFiles();
            updateMetrics();

            showAlert(`파일이 성공적으로 업로드되었습니다: ${file.name}`, 'success');
        }

        function updateFileList() {
            const fileListEl = document.getElementById('uploadedFiles');
            fileListEl.innerHTML = '';

            uploadedFiles.forEach(file => {
                const li = document.createElement('li');
                li.className = 'file-item';
                li.innerHTML = `
                    <i class="fas fa-file-alt"></i>
                    <span>${file.name}</span>
                    <button class="btn btn-danger" style="margin-left: auto; padding: 2px 8px; font-size: 12px;" 
                            onclick="removeFile('${file.name}')">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                fileListEl.appendChild(li);
            });
        }

        function removeFile(fileName) {
            uploadedFiles = uploadedFiles.filter(file => file.name !== fileName);
            updateFileList();
            saveUploadedFiles();
            updateMetrics();
            showAlert(`파일이 삭제되었습니다: ${fileName}`, 'warning');
        }

        // 데이터베이스 재구축
        function rebuildDatabase() {
            if (uploadedFiles.length === 0) {
                showAlert('업로드된 파일이 없습니다.', 'warning');
                return;
            }

            showAlert('데이터베이스를 재구축하는 중...', 'warning');
            
            // 진행 표시
            const loadingDiv = document.createElement('div');
            loadingDiv.innerHTML = '<div class="loading-spinner"></div>';
            document.body.appendChild(loadingDiv);

            setTimeout(() => {
                document.body.removeChild(loadingDiv);
                showAlert('데이터베이스 구축이 완료되었습니다!', 'success');
                updateMetrics();
            }, 3000);
        }

        // 채팅 관리 함수들
        function clearChat() {
            if (confirm('모든 대화를 삭제하시겠습니까?')) {
                chatHistory = [];
                sessionId = generateSessionId();
                
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = `
                    <div class="message assistant">
                        <div>안녕하세요! 사주명리 AI 상담사입니다. 궁금한 것이 있으시면 언제든 물어보세요.</div>
                        <div class="message-meta">
                            <i class="fas fa-robot"></i> ${new Date().toLocaleString()}
                        </div>
                    </div>
                `;
                
                saveChatHistory();
                updateMetrics();
                showAlert('대화가 삭제되었습니다.', 'success');
            }
        }

        function exportChat() {
            if (chatHistory.length === 0) {
                showAlert('저장할 대화가 없습니다.', 'warning');
                return;
            }

            const chatData = {
                sessionId: sessionId,
                timestamp: new Date().toISOString(),
                messages: chatHistory
            };

            const dataStr = JSON.stringify(chatData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `conversation_${sessionId.substring(0, 8)}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showAlert('대화가 저장되었습니다.', 'success');
        }

        // 설정 관리
        function saveSettings() {
            const settings = {
                model: document.getElementById('modelSelect').value,
                maxTokens: document.getElementById('maxTokens').value,
                temperature: document.getElementById('temperature').value,
                searchResults: document.getElementById('searchResults').value,
                vectorWeight: document.getElementById('vectorWeight').value,
                keywordWeight: document.getElementById('keywordWeight').value
            };

            localStorage.setItem('appSettings', JSON.stringify(settings));
            showAlert('설정이 저장되었습니다!', 'success');
        }

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
            
            if (settings.model) document.getElementById('modelSelect').value = settings.model;
            if (settings.maxTokens) document.getElementById('maxTokens').value = settings.maxTokens;
            if (settings.temperature) {
                document.getElementById('temperature').value = settings.temperature;
                document.getElementById('temperatureValue').textContent = settings.temperature;
            }
            if (settings.searchResults) document.getElementById('searchResults').value = settings.searchResults;
            if (settings.vectorWeight) {
                document.getElementById('vectorWeight').value = settings.vectorWeight;
                document.getElementById('vectorWeightValue').textContent = settings.vectorWeight;
            }
            if (settings.keywordWeight) {
                document.getElementById('keywordWeight').value = settings.keywordWeight;
                document.getElementById('keywordWeightValue').textContent = settings.keywordWeight;
            }
        }

        // 로컬 스토리지 관리
        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        }

        function loadChatHistory() {
            const saved = localStorage.getItem('chatHistory');
            if (saved) {
                chatHistory = JSON.parse(saved);
                refreshChatDisplay();
            }
        }

        function saveUploadedFiles() {
            localStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
        }

        function loadUploadedFiles() {
            const saved = localStorage.getItem('uploadedFiles');
            if (saved) {
                uploadedFiles = JSON.parse(saved);
                updateFileList();
            }
        }

        // 메트릭 업데이트
        function updateMetrics() {
            document.getElementById('totalDocs').textContent = uploadedFiles.length;
            document.getElementById('totalChunks').textContent = uploadedFiles.length * 3; // 파일당 평균 3개 청크로 가정
            document.getElementById('chatCount').textContent = chatHistory.filter(msg => msg.role === 'user').length;
        }

        // 유틸리티 함수들
        function generateSessionId() {
            return 'session_' + Math.random().toString(36).substr(2, 9);
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (document.body.contains(alertDiv)) {
                    document.body.removeChild(alertDiv);
                }
            }, 3000);
        }

        // 키보드 단축키
        document.addEventListener('keydown', function(e) {
            // Ctrl+Enter로 메시지 전송
            if (e.ctrlKey && e.key === 'Enter') {
                const chatInput = document.getElementById('chatInput');
                if (chatInput.value.trim()) {
                    sendMessage(chatInput.value.trim());
                    chatInput.value = '';
                }
            }
        });
    </script>
</body>
</html>
                                    